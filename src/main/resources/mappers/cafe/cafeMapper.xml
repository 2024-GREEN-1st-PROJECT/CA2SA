<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.green.ca2sa.cafe.CafeMapper">
    <update id="updCafe">
        UPDATE cafe
        <set>
            <if test="cafeName != null and cafeName != ''">
                cafeName = #{cafeName}
            </if>
            <if test="location != null and location != ''">
                ,location = #{location}
            </if>
            <if test="tel != null and tel != ''">
                ,tel = #{tel}
            </if>
            <if test="cafePic != null and cafePic != ''">
                ,cafePic = #{cafePic}
            </if>
            <if test="closeTime != null and closeTime != ''">
                ,closeTime = #{closeTime}
            </if>
            <if test="openTime != null and openTime != ''">
                ,openTime = #{openTime}
            </if>
            <if test="longitude != null">
                ,longitude = #{longitude}
            </if>
            <if test="latitude != null">
                ,latitude = #{latitude}
            </if>
        </set>
        WHERE cafeId = #{cafeId}
    </update>

    <insert id="insCafe" useGeneratedKeys="true" keyProperty="cafeId">
        INSERT INTO cafe
        SET

        cafeName = #{cafeName}, location = #{location}, tel = #{tel}, cafePic = #{cafePic},
        closeTime = #{closeTime}, openTime = #{openTime}, businessNumber = #{businessNumber},
        latitude = #{latitude}, longitude = #{longitude} , userId = #{userId}

    </insert>

    <select id="selCafe">
        SELECT
        cafeId, cafeName, location, tel, cafePic, openTime, closeTime
        FROM cafe
        where cafeId = #{cafeId}
    </select>

    <select id="selAllCafe">
        select
        ROUND(6371000  * ACOS(COS(RADIANS(#{userLatitude})) * COS(RADIANS(latitude)) * COS(RADIANS(longitude) - RADIANS(#{userLongitude})) + SIN(RADIANS(#{userLatitude})) * SIN(RADIANS(latitude)))) AS distance,
        cafeName, location, tel, cafePic, cafeId, openTime, closeTime, latitude, longitude
        from cafe
        HAVING distance <![CDATA[ <= ]]> 1000

    </select>

    <select id="searchCafe">
        SELECT
        ROUND(6371000 * ACOS(COS(RADIANS(#{userLatitude})) * COS(RADIANS(latitude)) * COS(RADIANS(longitude) - RADIANS(#{userLongitude})) + SIN(RADIANS(#{userLatitude})) * SIN(RADIANS(latitude)))) AS distance,
        cafeName, location, tel, cafePic, a.cafeId, openTime, closeTime, latitude, longitude
        FROM cafe a
        JOIN menu b
        ON a.cafeId = b.cafeId
        WHERE 1=1
        <if test="searchMenuName != null and searchMenuName != ''">
            AND menuName LIKE '%${searchMenuName}%'
        </if>
        <if test="searchCafeName != null and searchCafeName != ''">
            AND cafeName LIKE '%${searchCafeName}%'
        </if>
        GROUP BY cafeId
        HAVING distance <![CDATA[<=]]> #{maxDistance}
    </select>

</mapper>